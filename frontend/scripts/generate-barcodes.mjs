import fs from 'node:fs';
import path from 'node:path';
import bwipjs from 'bwip-js';

const projectRoot = path.resolve(path.dirname(new URL(import.meta.url).pathname), '..');

const outDir = path.join(projectRoot, 'assets', 'barcodes', 'nike');
const outDataFile = path.join(projectRoot, 'src', 'data', 'products.generated.ts');

/**
 * Compute EAN-13 check digit from a 12-digit numeric string.
 * https://en.wikipedia.org/wiki/International_Article_Number
 */
function ean13CheckDigit(twelveDigits) {
  if (!/^\d{12}$/.test(twelveDigits)) {
    throw new Error(`EAN-13 base must be 12 digits, got: ${twelveDigits}`);
  }
  const digits = twelveDigits.split('').map((d) => Number(d));
  let sum = 0;
  for (let i = 0; i < digits.length; i++) {
    // From the right: positions 1,3,5... are weighted 3.
    // With 0-based index from left, this becomes: weight 1 for even indexes, 3 for odd.
    sum += digits[i] * (i % 2 === 0 ? 1 : 3);
  }
  const mod = sum % 10;
  return mod === 0 ? 0 : 10 - mod;
}

function makeEan13(base12) {
  const cd = ean13CheckDigit(base12);
  return `${base12}${cd}`;
}

const products = [
  {
    id: 'nike-af1-goretex-vibram',
    brand: 'Nike',
    name: 'Air Force 1 GORE-TEX Vibram',
    price: 150,
    eanBase12: '299000000001',
    imageAsset: 'assets/products/Nike/Air Force 1 GORE-TEX Vibram.png',
  },
  {
    id: 'nike-aj1-low-g',
    brand: 'Nike',
    name: 'Air Jordan 1 Low G',
    price: 155,
    eanBase12: '299000000002',
    imageAsset: 'assets/products/Nike/Air Jordan 1 Low G.png',
  },
  {
    id: 'nike-solo-swoosh',
    brand: 'Nike',
    name: 'Nike Solo Swoosh',
    price: 105,
    eanBase12: '299000000003',
    imageAsset: 'assets/products/Nike/Nike Solo Swoosh.png',
  },
];

fs.mkdirSync(outDir, { recursive: true });
fs.mkdirSync(path.dirname(outDataFile), { recursive: true });

const generated = [];

for (const p of products) {
  const barcode = makeEan13(p.eanBase12);

  const png = await bwipjs.toBuffer({
    bcid: 'ean13',
    text: barcode,
    scale: 4,
    height: 16,
    includetext: true,
    textxalign: 'center',
  });

  const fileName = `${p.id}-${barcode}.png`;
  const filePath = path.join(outDir, fileName);
  fs.writeFileSync(filePath, png);

  generated.push({
    id: p.id,
    brand: p.brand,
    name: p.name,
    price: p.price,
    barcode,
    barcodeType: 'ean13',
    barcodeImage: `assets/barcodes/nike/${fileName}`,
    imageAsset: p.imageAsset,
  });
}

const ts = `// AUTO-GENERATED by scripts/generate-barcodes.mjs
// Do not edit by hand.

export type GeneratedProduct = {
  id: string;
  brand: string;
  name: string;
  price: number;
  barcode: string;
  barcodeType: 'ean13';
  barcodeImage: string;
  imageAsset?: string;
};

export const generatedProducts: GeneratedProduct[] = ${JSON.stringify(generated, null, 2)} as const;

export const generatedProductByBarcode: Record<string, GeneratedProduct> = Object.fromEntries(
  generatedProducts.map((p) => [p.barcode, p])
);
`;

fs.writeFileSync(outDataFile, ts, 'utf8');

console.log(`Wrote ${generated.length} products -> ${path.relative(projectRoot, outDataFile)}`);
console.log(`Wrote barcodes -> ${path.relative(projectRoot, outDir)}`);
console.log('Barcodes:');
for (const p of generated) {
  console.log(`- ${p.name}: ${p.barcode} ($${p.price})`);
}
